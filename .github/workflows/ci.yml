name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build:
    uses: ./.github/workflows/reusable/build.yml
    with:
      image-tag: pr-${{ github.event.pull_request.number }}

  test:
    needs: build
    uses: ./.github/workflows/reusable/test.yml
    with:
      python-version: '3.11'

  static-analysis:
    needs: test
    uses: ./.github/workflows/reusable/static-analysis.yml
    with:
      python-version: '3.11'

  summarize:
    runs-on: ubuntu-latest
    needs: [build, test, static-analysis]
    steps:
      - name: Create check summary
        uses: actions/github-script@v6
        with:
          script: |
            const conclusions = {
              passing: 'all checks passed',
              failing: 'some checks failed'
            }
            const refs = github.context.payload.pull_request ? [github.context.payload.pull_request.number] : []
            core.info(`CI summary for PR #${github.context.payload.pull_request.number}`)
