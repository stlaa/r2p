name: Update PR Labels Based on CI

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  pull-requests: write
  contents: read

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Label PRs based on CI result
        uses: actions/github-script@v6
        with:
          script: |
            const run = context.payload.workflow_run
            const conclusion = run.conclusion
            const prs = run.pull_requests || []
            if (prs.length === 0) {
              core.info('No PRs associated with this run');
              return
            }
            for (const pr of prs) {
              const labelsToAdd = []
              const labelsToRemove = []
              if (conclusion === 'success') labelsToAdd.push('ci: passing')
              else labelsToAdd.push('ci: failing')
              // Remove the opposite label if present
              if (conclusion === 'success') labelsToRemove.push('ci: failing')
              else labelsToRemove.push('ci: passing')

              const owner = context.repo.owner
              const repo = context.repo.repo
              const prNumber = pr.number

              // Add labels
              if (labelsToAdd.length) {
                await github.rest.issues.addLabels({owner, repo, issue_number: prNumber, labels: labelsToAdd})
              }

              // Remove labels
              for (const l of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({owner, repo, issue_number: prNumber, name: l})
                } catch (e) {
                  // ignore if not present
                }
              }
            }
